<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PLT</title>
    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/plugin-html-keyboard-response.js"></script>
    <script src="jspsych/plugin-instructions.js"></script>
    <script src="jspsych/plugin-call-function.js"></script>
    <script src="jspsych/plugin-preload.js"></script>
    <script src="plugin-PLT.js"></script>
    <script src="plugin-coin-lottery.js"></script>
    <script src="instructions.js"></script>
    <script src="utils.js"></script>
    <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />
</head>
<style>
    .jsPsychDE {
        position: absolute;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
    }

    .instructions p {
        width: 700px;
        text-align: left;
    }
</style>
<body>
    <div id='display_element' class='jsPsychDE'></div>
</body>
<script>
    code_version = 0.1

    // Conditions:
    // First digit - early stopping. 0 - no early stopping, 1 - early stopping
    // Second digit - valence grouped / interleaved. 0 - interleaved, 1 - grouped.
    // Third digit - reward first. 0 - punishment first, 1 - reward first, undefined - NA

    // Initialize jsPysch object
    let jsPsych = initJsPsych({
        display_element: 'display_element',
    });

    // Get condition from URL, all caps are prolific, lowercase are ours
    window.condition = jsPsych.data.getURLVariable('cond');
    window.prolificPID = jsPsych.data.getURLVariable('PROLIFIC_PID');
    window.studyId = jsPsych.data.getURLVariable('STUDY_ID');
    window.sessionId = jsPsych.data.getURLVariable('SESSION_ID');
    window.sessionNum = jsPsych.data.getURLVariable('session_num');

    // Parse condition
    window.earlyStop = window.condition[0] == "1"
    window.valenceGrouped = window.condition[1] == "1"
    window.rewardFirst = window.condition[2] == "1"

    // Save participant variables to data
    jsPsych.data.addProperties({
        prolific_pid: window.prolificPID,
        study_id: window.studyId,
        session_id: window.sessionId,
        session: window.sessionNum,
        condition: window.condition,
        early_stop: window.earlyStop,
        valence_grouped: window.valenceGrouped,
        reward_first: window.rewardFirst
    })

    window.skipThisBlock = false;
    
    inter_block_msg = {
        type: jsPsychHtmlKeyboardResponse,
        choices: ['arrowright', 'arrowleft'],
        css_classes: ['instructions'],
        stimulus: function(){
            let valence = jsPsych.data.get().filter({trial_type: "PLT"}).last(1).select("valence").values[0];
            let num_observed = countPLTAfterLastNonPLT(jsPsych.data.get().filter([
                {trial_type: "PLT"},
                {trialphase: "inter_block"}, 
                {trialphase: "change_valence"}, 
                {trialphase: "instructions"}]).select('trial_type').values)
            
            let past_feedback_right = jsPsych.data.get().filter({trial_type: "PLT"}).last(num_observed).select('outcomeRight').values
            let past_feedback_left = jsPsych.data.get().filter({trial_type: "PLT"}).last(num_observed).select('outcomeLeft').values
            let sum_past_high_magnitude = getSumofMax(past_feedback_right, past_feedback_left)
            let remaining_feedback = Math.round((10 - sum_past_high_magnitude) * 1000) / 1000
            
            if (earlyStop & window.skipThisBlock){
                txt = "<p>You've found the better card.</p><p>You will skip the remaining turns, and ";
                
                txt += valence == 1 ? ("automatically win all the remaining £" + remaining_feedback + " in coins left hidden under this card.") : 
                    ("lose only the " +  (13 - num_observed) + " pence left hidden under this card.")

                txt += "</p><p>Place your fingers on the left and right arrow keys, and press either one to start the next round.</p>";

                return  txt
            
            }else{
                return "<p>This is the end of this round.</p>\
                    <p>Place your fingers on the left and right arrow keys, and press either one to start the next round.</p>";
            }
        },
        data: {
            trialphase: "inter_block",
        },
        on_start: saveDataREDCap,
        on_finish: () => {window.skipThisBlock = false}
    }

    inter_valence_msg = [
        {
            type: jsPsychHtmlKeyboardResponse,
            choices: ['space'],
            css_classes: ['instructions'],
            stimulus: function(){
                if ((window.rewardFirst & window.sessionNum == 1) | ((!window.rewardFirst) & window.sessionNum == 2)) {
                    return "<p>Well done.</p><p>You will now continue playing the Card Collector's Challenge, \
                        but this time to <b>avoid losing coins</b>. To start this part of the challenge, you recieve a purse with \
                        £x in coins. Every broken coin you discover will be deducted from your purse.</p>\
                        <p>Your goal is to lose as few coins as possible. Your bonus payment will be based on the number of \
                            coins you have left at the end of the challenge.</p>\
                            <p>Press the space bar to continue.</p>"
                } else {
                    return "<p>Well done.</p><p>You will now continue playing the Card Collector's Challenge, \
                        but this time to <b>win coins</b>.</p>\
                        <p>Your goal is to win as many coins as possible. Your bonus payment will be based on the number of \
                            coins you have at the end of the challenge.</p>\
                            <p>Press the space bar to continue.</p>"
                }
            },
            data: {
                trialphase: "change_valence",
            },
            on_start: saveDataREDCap,
            on_finish: () => {window.skipThisBlock = false}
        },
        {
            type: jsPsychHtmlKeyboardResponse,
            choice: ['rightarrow', 'leftarrow'],
            stimulus: "<p>Place your fingers on the left and right arrow keys, and press either one to start playing again.</p>",
            data: {
                trialphase: "change_valence"
            }
        }
    ]

    PLT_trial =  {
        timeline: [{
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '<div style="font-size:60px">+</div>',
            choices: "NO_KEYS",
            trial_duration: 800,
            data: {trialphase: "fixation"},
        },
        {
            type: jsPsychPLT,
            imgLeft: () => 'imgs/'+ jsPsych.timelineVariable('stimulus_left'),
            imgRight: () => 'imgs/'+ jsPsych.timelineVariable('stimulus_right'),
            outcomeLeft: jsPsych.timelineVariable('feedback_left'),
            outcomeRight: jsPsych.timelineVariable('feedback_right'),
            optimalRight: jsPsych.timelineVariable('optimal_right'),
            maxRespTime: () => jsPsych.timelineVariable('maxRespTime') == undefined ? 
                3000 : jsPsych.timelineVariable('maxRespTime'),
            data: {
                trialphase: "task",
                block: jsPsych.timelineVariable('block'),
                trial: jsPsych.timelineVariable('trial'),
                valence: jsPsych.timelineVariable('valence')
            }
        }
        ],
        conditional_function: function(){

            // Only consider stopping if this is an early stop group, if this is not a practice block, and if there had been at least five previous trials
            if (window.earlyStop && 
                Number.isInteger(jsPsych.timelineVariable('block')) && 
                jsPsych.timelineVariable('trial') > 5){

                    // Compute number of previous optimal choices in the past 5 trials
                    let num_optimal = jsPsych.data.get().filter({
                        trial_type: "PLT"
                    }).last(5).select('isOptimal').sum()

                    window.skipThisBlock = true;

                    return num_optimal < 5
            }
            
        }
    } 
    
    function build_PLT_task(structure, insert_msg = true){
        let PLT_task = [];
        for (let i=0; i < structure.length; i++){
            block = [
                {
                    timeline: [
                        {
                            type: jsPsychPreload,
                            images: [
                                "imgs/" + structure[i][0]["stimulus_right"],
                                "imgs/" + structure[i][0]["stimulus_left"]
                            ],
                        },
                        PLT_trial
                    ],
                    timeline_variables: structure[i]
                }
            ];
            
            // Add message
            if (insert_msg){
                if (window.valenceGrouped & (i == (totalBlockNumber / 2 - 1))) {
                    block.push(inter_valence_msg);
                } else {
                    block.push(inter_block_msg);
                }
            }
            
            PLT_task = PLT_task.concat(block)
        }

        return PLT_task
    }

    async function load_squences(condition, session) {
        try {
            const response = await fetch('PLT_task_structure_' + condition + '.json');
            
            if (!response.ok) {
            throw new Error('Network response was not ok');
            }
            const structure = await response.json();
            const sess_structure = structure[session - 1];

            window.totalBlockNumber = sess_structure.length

            // Fetch the current time from the World Time API
            const time_resp = await fetch('http://worldtimeapi.org/api/timezone/Europe/London');

            if (!time_resp.ok) {
            throw new Error('Network response was not ok');
            }

            const date_data = await time_resp.json();

            const verifiedDateString = date_data.datetime;

            window.startTime = format_date_from_string(verifiedDateString)

            run_full_experiment(sess_structure);
        } catch (error) {
            console.error('There was a problem with the fetch operation:', error);
        }
    }

    function run_full_experiment(structure){

        // Preload images
        procedure = [
            {
                type: jsPsychPreload,
                images: [
                    "1penny.png", "1pennybroken.png",
                    "1pound.png", "1poundbroken.png",
                    "50pence.png", "50pencebroken.png"
                ].map(s => "imgs/" + s)
            }
        ]

        procedure.push({
            type: jsPsychCoinLottery
        });

        
        // Add instructions
        // procedure = procedure.concat(prepare_instructions());

        // Add PLT
        procedure = procedure.concat(build_PLT_task(structure));

        // Final messages and data saving
        procedure.push({                
            type: jsPsychHtmlKeyboardResponse,
            stimulus: "Well done! You have finished the experiment.",
            data: {trialphase: "end"},
            on_start: saveDataREDCap
        })

        // Run
        jsPsych.run(procedure);
    }

    // Load sequences and start
    var procedure = [];

    load_squences(window.condition, window.sessionNum);
        
</script>
</html>