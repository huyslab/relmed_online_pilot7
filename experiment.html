<!DOCTYPE html>
<html>

<head>
  <title>Box Shaking Experiment</title>
  <script src="jspsych/jspsych.js"></script>
  <script src="jspsych/plugin-html-keyboard-response.js"></script>
  <script src="jspsych/plugin-html-button-response.js"></script>
  <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />
  <style>
    .experiment-wrapper {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      width: 100vw;
    }

    #experiment-container {
      position: relative;
      width: 50vmin;
      /* Use vmin for better scaling across devices */
      height: 80vmin;
      display: flex;
      justify-content: center;
    }

    #piggy-bank {
      position: absolute;
      height: 40%;
      top: 0%;
      object-fit: contain;
      transition: transform 0.1s;
      /* Add a smooth transition but don't affect wigglePiggy*/
    }

    #coin-container {
      position: absolute;
      display: flex;
      justify-content: center;
      height: 60%;
      width: 100%;
      top: 40%;
      /* overflow: hidden; */
    }

    .coin {
      position: absolute;
      height: 30%;
      object-fit: contain;
      top: 0%;
      opacity: 0;
    }

    @keyframes dropCoin {
      0% {
        /* transform: translate(0vmin, -10vmin); */
        top: -15%;
        opacity: 0.8;
      }

      50% {
        /* transform: translate(0vmin, 40vmin); */
        top: 70%;
        /* % here is relative to the size of coin? */
        opacity: 1;
      }

      100% {
        /* transform: translate(0vmin, 40vmin); */
        top: 70%;
        opacity: 0;
      }
    }

    .coin-drop {
      animation: dropCoin 1s ease-in-out;
    }

    #info-container {
      height: 5vmin;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    #reward-counter,
    #trial-info {
      font-size: 3vmin;
      margin: 1vmin 0;
      display: block;
    }

    @keyframes wigglePiggy {
      0% {
        transform: translate(1%, 1%) rotate(0deg);
      }

      10% {
        transform: translate(-1%, -1.5%) rotate(-2deg);
      }

      20% {
        transform: translate(-2%, 0%) rotate(2deg);
      }

      30% {
        transform: translate(2%, 1.5%) rotate(0deg);
      }

      40% {
        transform: translate(1%, -1%) rotate(2deg);
      }

      50% {
        transform: translate(-1%, 1.5%) rotate(-2deg);
      }

      60% {
        transform: translate(-2%, 1%) rotate(0deg);
      }

      70% {
        transform: translate(2%, 1%) rotate(-2deg);
      }

      80% {
        transform: translate(-1%, -1%) rotate(2deg);
      }

      90% {
        transform: translate(1%, 1.5%) rotate(0deg);
      }

      100% {
        transform: translate(1%, -1.5%) rotate(-2deg);
      }
    }

    .grayscale-blur {
      filter: grayscale(100%) blur(5px);
      opacity: 0.9;
    }

    #iti-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 3vmin;
      color: #333;
      text-align: center;
      z-index: 10;
    }

    #progress-container {
      width: 50vmin;
      height: 3vmin;
      background-color: #e0e0e0;
      /* Light gray background */
      border-radius: 1.5vmin;
      margin-top: 2vmin;
      overflow: hidden;
      position: relative;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
      /* Subtle inner shadow for depth */
    }

    #progress-bar {
      height: 100%;
      width: 0%;
      background-color: #90a4ae;
      /* Soft blue-gray */
      transition: width 0.2s ease-in-out;
    }

    #progress-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #546e7a;
      /* Dark blue-gray for text */
      font-size: 2vmin;
      font-weight: bold;
    }
  </style>
</head>

<body>
  <div id="jspsych-content"></div>
  <script>
    const jsPsych = initJsPsych({
      on_finish: function () {
        jsPsych.data.displayData();
      }
    });

    // Configuration object
    const experimentConfig = {
      ratios: [1],
      magnitudes: [1, 2, 5, 10, 20, 50, 100, 200],
      trialDuration: 600, // in milliseconds
      minITI: 1400,
      maxITI: 1600
    };

    window.totalReward = 0;
    window.totalPresses = 0;

    // Generate trials
    function generateTrials() {
      let trials = [];
      for (let magnitude of experimentConfig.magnitudes) {
        for (let ratio of experimentConfig.ratios) {
          trials.push({ magnitude, ratio });
        }
      }
      return jsPsych.randomization.shuffle(trials);
    }

    // Trial stimulus function
    function generateTrialStimulus(magnitude, ratio) {
      const magnitude_text = (magnitude / 100).toLocaleString('en-GB', { style: 'currency', currency: 'GBP' });
      const ratio_text = ratio === 1 ? 'time' : 'times';
      return `
    <div class="experiment-wrapper">
      <div id="experiment-container">
        <div id="coin-container"></div>
        <img id="piggy-bank" src="img/piggy-bank.png" alt="Piggy Bank">
      </div>
      <div id="info-container">
        <div id="trial-info">Press ${ratio + ' ' + ratio_text} for ${magnitude_text}</div>
      </div>
      <div id="progress-container">
        <div id="progress-bar"></div>
        <div id="progress-text">0/${ratio}</div>
      </div>
    </div>
  `;
    }

    // Functions for animation

    function shakePiggy() {
      const piggyBank = document.getElementById('piggy-bank');
      piggyBank.style.transform = 'translateX(-2%)';
      setTimeout(() => {
        piggyBank.style.transform = 'translateX(2%)';
        setTimeout(() => {
          piggyBank.style.transform = 'translateX(0)';
        }, 50);
      }, 50);
    }

    function wigglePiggy() {
      const piggyBank = document.getElementById('piggy-bank');
      piggyBank.style.animation = 'wigglePiggy 0.1s ease-in-out';
      piggyBank.style.animationIterationCount = '1';
      setTimeout(() => {
        piggyBank.style.animation = '';
      }, 100);
    }

    function dropCoin(magnitude) {
      const coinContainer = document.getElementById('coin-container');
      const coin = document.createElement('img');
      coin.className = 'coin';
      coin.src = `img/${magnitude}p.png`;
      coin.alt = `Coin of value ${magnitude}`;

      // Random horizontal position
      // const randomLeft = Math.random() * 20 + 40;
      // const randomLeft = 40;
      // coin.style.left = `${randomLeft}%`;

      coinContainer.appendChild(coin);

      // Trigger the animation
      coin.classList.add('coin-drop');
      // Remove the coin element after animation
      coin.addEventListener('animationend', () => {
        coin.remove();
      });
    }

    // Box shaking trial
    const boxShakingTrial = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function () {
        return generateTrialStimulus(jsPsych.evaluateTimelineVariable('magnitude'), jsPsych.evaluateTimelineVariable('ratio'));
      },
      choices: 'NO_KEYS',
      // response_ends_trial: false,
      trial_duration: experimentConfig.trialDuration,
      save_timeline_variables: true,
      data: {
        trial_presses: () => { return window.trialPresses },
        trial_reward: () => { return window.trialReward },
        response_time: () => { return window.responseTime },
        // Record global data
        total_presses: () => { return totalPresses },
        total_reward: () => { return totalReward }
      },
      on_start: function (trial) {
        // Create a shared state object
        window.trialPresses = 0;
        window.trialReward = 0;
        window.responseTime = [];

        let lastPressTime = 0;
        let pressCount = 0;

        const ratio = jsPsych.evaluateTimelineVariable('ratio');
        const magnitude = jsPsych.evaluateTimelineVariable('magnitude');

        const keyboardListener = jsPsych.pluginAPI.getKeyboardResponse({
          callback_function: function (info) {
            window.responseTime.push(info.rt - lastPressTime);
            lastPressTime = info.rt;
            // wigglePiggy();
            shakePiggy();
            pressCount++;
            window.trialPresses++;
            window.totalPresses++;

            // Update progress bar
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const progress = (pressCount / ratio) * 100;
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${pressCount}/${ratio}`;

            if (pressCount === ratio) {
              window.trialReward += magnitude;
              window.totalReward += magnitude;
              // document.getElementById('reward-counter').innerHTML = `Total Reward: ${window.totalReward}`;
              pressCount = 0;
              dropCoin(magnitude);

              // Show full progress bar briefly before resetting
              progressBar.style.backgroundColor = '#78909c'; // Slightly darker shade for completion
              setTimeout(() => {
                pressCount = 0;
                progressBar.style.width = '0%';
                progressBar.style.backgroundColor = '#90a4ae'; // Reset to original color
                progressText.textContent = `0/${ratio}`;
              }, 200);
            }
          },
          valid_responses: [' '],
          rt_method: 'performance',
          persist: true,
          allow_held_key: false,
          minimum_valid_rt: 50
        });
      },
      on_load: function () {
        const magnitude_index = experimentConfig.magnitudes.indexOf(jsPsych.evaluateTimelineVariable('magnitude'));
        document.getElementById('piggy-bank').style.filter = `hue-rotate(${magnitude_index * 45}deg)`;
      },
      on_finish: function (data) {
        // Clean up listener
        jsPsych.pluginAPI.cancelAllKeyboardResponses();
      }
    };

    // Inter-trial interval
    const interTrialInterval = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function () {
        return `
      <div class="experiment-wrapper">
        <div id="experiment-container">
          <img id="piggy-bank" src="img/piggy-bank.png" alt="Piggy Bank" class="grayscale-blur">
        </div>
        <div id="info-container">
          <div id="iti-text">Preparing next trial...</div>
        </div>
        <div id="progress-container" style="visibility: hidden;">
          <div id="progress-bar"></div>
          <div id="progress-text"></div>
        </div>
      </div>
        `;
      },
      choices: "NO_KEYS",
      on_start: function (trial) {
        trial.trial_duration = Math.floor(Math.random() * (experimentConfig.maxITI - experimentConfig.minITI) + experimentConfig.minITI);
      },
      save_trial_parameters: { trial_duration: true }
    };

    // Create timeline
    // Instructions
    const instructions = {
      type: jsPsychHtmlButtonResponse,
      stimulus: `
        <p>Welcome to the Box Shaking Experiment!</p>
        <p>In this experiment, you will see a box on the screen.</p>
        <p>Your task is to press the spacebar to shake the box.</p>
        <p>Sometimes, shaking the box will result in a coin dropping.</p>
        <p>The number of shakes needed for a coin to drop and the value of the coin will change throughout the experiment.</p>
        <p>Try to earn as many points as possible!</p>
        <p>Each trial will last for 6 seconds, followed by a short break.</p>
        <p>Press the button below when you're ready to begin.</p>
    `,
      choices: ['Start Experiment']
    };

    // Generate trials
    const trials = generateTrials();

    // Create main experiment timeline
    const experimentTimeline = [];
    trials.forEach(trial => {
      experimentTimeline.push({
        timeline: [boxShakingTrial, interTrialInterval],
        timeline_variables: [trial]
      });
    });

    // Debriefing
    const debriefing = {
      type: jsPsychHtmlButtonResponse,
      stimulus: function () {
        return `
            <p>Thank you for participating in the experiment!</p>
            <p>You earned a total of ${(totalReward / 100).toLocaleString('en-GB', { style: 'currency', currency: 'GBP' })} in the game.</p>
            <p>In this experiment, we were studying how different reward schedules and magnitudes affect behavior.</p>
            <p>Sometimes you needed more shakes to get a reward, and sometimes the rewards were larger.</p>
            <p>Your data will help us understand how people respond to different patterns of reinforcement.</p>
            <p>If you have any questions about the experiment, please ask the experimenter now.</p>
        `;
      },
      choices: ['Finish']
    };

    // Combine all parts into the full timeline
    const fullTimeline = [
      instructions,
      ...experimentTimeline.slice(0, 8),
      debriefing
    ];

    // Run the experiment
    jsPsych.run(fullTimeline);
  </script>
</body>

</html>