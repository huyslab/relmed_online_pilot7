<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PLT</title>
    <script src="jspsych/jspsych.js"></script>
    <script>
        // Initialize jsPysch object
        let jsPsych = initJsPsych({
            display_element: 'display_element',
        });
    </script>
    <script src="jspsych/plugin-html-keyboard-response.js"></script>
    <script src="jspsych/plugin-html-button-response.js"></script>
    <script src="jspsych/plugin-browser-check.js"></script>
    <script src="jspsych/plugin-instructions.js"></script>
    <script src="jspsych/plugin-survey-multi-choice.js"></script>
    <script src="jspsych/plugin-call-function.js"></script>
    <script src="jspsych/plugin-preload.js"></script>
    <script src="jspsych/plugin-survey-likert.js"></script>
    <script src="jspsych/plugin-survey-text.js"></script>
    <script src="jspsych/plugin-fullscreen.js"></script>
    <script src="plugin-PLT.js"></script>
    <script src="plugin-reversal.js"></script>
    <script src="pilot4_reversal_sequence.js"></script>
    <script src="plugin-coin-lottery.js"></script>
    <script src="utils.js"></script>
    <script src="PILT.js"></script>
    <script src="PILT_instructions.js"></script>
    <script src="vigour.js"></script>
    <script src="vigour_instructions.js"></script>
    <script src="post-vigour-test.js"></script>
    <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />
    <link href="vigour_styles.css" rel="stylesheet" type="text/css" />
    <link href="reversal.css" rel="stylesheet" type="text/css" />
</head>
<style>
    .jsPsychDE {
        position: absolute;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
    }

    .instructions p {
        width: 700px;
        text-align: left;
    }

    .instructions td {
        padding-left: 20px;
        padding-right: 20px
    }
</style>
<body>
    <div id='display_element' class='jsPsychDE'></div>
    <div id="persist-coin-container"></div>
</body>
<script>

    const rev_n_trials = 200;

    const reversal_timeline = JSON.parse(reversal_json);

    var reversal_blocks = [];
    for (i=0; i<reversal_timeline.length; i++){
        reversal_blocks.push([
            {
                timeline: [
                    {
                        timeline: [{
                            type: jsPsychReversal,
                            feedback_right: jsPsych.timelineVariable('feedback_right'),
                            feedback_left: jsPsych.timelineVariable('feedback_left'),
                            optimal_right: jsPsych.timelineVariable('optimal_right')
                        }],
                        conditional_function: () => {

                            // Check whether participants are up to crtierion
                            const criterion = jsPsych.evaluateTimelineVariable('criterion');

                            let num_correct = jsPsych.data.get()
                                .filter({block: jsPsych.evaluateTimelineVariable('block'), trial_type: 'reversal'})
                                .select('response_optimal').sum()

                            // Check whether trial limit reached
                            let n_trials = jsPsych.data.get()
                            .filter({trial_type: 'reversal'})
                            .count()

                            return (n_trials < rev_n_trials) && (num_correct < criterion)
                    }
                }
                ],
                timeline_variables: reversal_timeline[i],
                data: {
                    block: jsPsych.timelineVariable('block'),
                    trial: jsPsych.timelineVariable('trial')
                }
            }
        ]);
    }

    jsPsych.run(reversal_blocks);
        
</script>
</html>